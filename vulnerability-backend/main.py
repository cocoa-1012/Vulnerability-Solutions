#!/usr/bin/env python3
# -*- coding: utf-8 -*-
from typing import Dict

from fastapi import Depends, FastAPI, HTTPException, Query, Request
from fastapi.middleware.cors import CORSMiddleware

from model import VulnerabilityInput, VulnerabilityOutput
from user import (User, UserCreate, UserDB, UserUpdate, auth_backends,
                  fastapi_users)
from vulnerability import (create_vulnerability, fetch_all_vulnerabilities,
                           fetch_one_vulnerability, list_users,
                           remove_vulnerability, update_vulnerability)

# Initiating FastAPI Server
app = FastAPI()

# Managing CORS for the React Frontend connections
origins = ["*"]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"]
)


# --- User Authentication Routes ----------------------------------------------

# Learn more at https://frankie567.github.io/fastapi-users/configuration/routers/

# Add route for Login                           POST "/auth/login", "/auth/register"
app.include_router(
    fastapi_users.get_auth_router(auth_backends[0]),
    prefix="/auth",
    tags=["auth"]
)


def on_after_register(user: UserDB, request: Request):
    print("User {user.id} has registered.")


app.include_router(
    # fastapi_users.get_register_router(),
    fastapi_users.get_register_router(on_after_register),
    prefix="/auth",
    tags=["auth"]
)

# Add route for User utilities "/auth/users/*"

"""
    Get current logged in user profile          GET "/auth/users/me"
    Update current logged in user profile       PATCH "/auth/users/me"
    Get "_id" user profile                      GET "/auth/users/"
    Update "_id" user profile                   PATCH "/auth/users/{id}"
    Delete "_id" user profile                   DELETE "/auth/users/{id}"
"""

app.include_router(
    fastapi_users.get_users_router(),
    prefix="/auth/users",
    tags=["auth"]
)

# Add route for Reset Password utility

"""
    Forgot Password                             POST /auth/users/forgot-password
    Reset Password                              POST /auth/users/reset-password
"""

app.include_router(
    fastapi_users.get_reset_password_router("SECRET"),
    prefix="/auth/users",
    tags=["auth"]
)

# ----------------- Vulnerability CRUD urls --------------------------------
@app.get("/api/all-users", tags=["vulnerability solution crud"])
async def get_all_user():
    response = await list_users()
    return response


@app.get("/api/vulnerability", tags=["vulnerability solution crud"])
async def get_vulnerability(user: User = Depends(fastapi_users.get_current_user)):
    response = await fetch_all_vulnerabilities(user)
    return response




@app.post("/api/vulnerability/", response_model=VulnerabilityOutput, tags=["vulnerability solution crud"])
async def post_vulnerability(vulnerability: VulnerabilityInput, user: User = Depends(fastapi_users.get_current_user)):
    
    response = await create_vulnerability(vulnerability.dict())
    
    if response:
        return response
    raise HTTPException(400, "Something went wrong")


@app.put("/api/vulnerability/{id}/", response_model=VulnerabilityOutput, tags=["vulnerability solution crud"])
async def put_vulnerability(id: str, body: VulnerabilityInput, user: User = Depends(fastapi_users.get_current_user)):
    vulnerability = await fetch_one_vulnerability(id)
    
    if not vulnerability: 
        raise HTTPException(404, f"There is no vulnerability with the id {id}")
    if user.is_superuser or vulnerability['user'] == str(user.id):
        response = await update_vulnerability(id, body)
        return response
    
    raise HTTPException(401, "You are not authorized")

@app.get("/api/vulnerability/{id}", response_model=VulnerabilityOutput, tags=["vulnerability solution crud"])
async def get_vulnerability_by_id(id, user: User = Depends(fastapi_users.get_current_user)):
    response = await fetch_one_vulnerability(id)
    if not response: 
        raise HTTPException(404, f"There is no vulnerability with the id {id}")
    if user.is_superuser or response['user'] == str(user.id):
        return response;
    
    raise HTTPException(401, "You are not authorized")


@app.delete("/api/vulnerability/{id}", tags=["vulnerability solution crud"])
async def delete_vulnerability(id, user: User = Depends(fastapi_users.get_current_user)):
    vulnerability = await fetch_one_vulnerability(id)
    if not vulnerability: 
        raise HTTPException(404, f"There is no vulnerability with the id {id}")
    if user.is_superuser or vulnerability['user'] == str(user.id):
        response = await remove_vulnerability(id)
        if response:
            return {"result": True, "msg": "Successfully deleted vulnerability", "_id": id}
    
    raise HTTPException(401, "You are not authorized")


